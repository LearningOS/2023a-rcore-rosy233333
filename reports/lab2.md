# 第一次实验报告

## 学习内容

虚拟内存，段页式管理的实现。

## chapter4练习的实现功能总结

我重写了`sys_get_time`和`sys_task_info`函数，使它们恢复正常功能。为了做到这点，我编写了`map_user_va_to_pa`函数，将用户空间的虚拟地址转化为物理地址。通过该函数，我将`sys_get_time`和`sys_task_info`函数的输入的指针参数进行了地址变换，再完成之前的工作。

我实现了`mmap`和`munmap`系统调用。它们首先检查输入参数的合法性，再通过`TASK_MANAGER`获得当前进程的pcb，进而获得当前进程的用户地址空间。之后，调用我实现的地址空间的`map_va_range`和`unmap_va_range`方法，完成对应的操作。

## 问答题

### 1. 请列举 SV39 页表页表项的组成，描述其中的标志位有何作用？

由物理页号、标志位和保留位组成。标识这个页表项是否有效、是否可读可写可执行、是否允许用户访问、是否被访问过、是否被修改过等信息。

### 2.

#### 1)请问哪些异常可能是缺页导致的？

和内存访问相关的异常，例如非法地址异常。

#### 2)发生缺页时，描述相关重要寄存器的值，上次实验描述过的可以简略。

sstatus：一些信息，包括CPU处于什么特权级

spec：发生缺页中断的指令的地址

scause：原因（缺页中断）

stvec：若在用户态，则指向保存现场和切换到内核态的代码；若在内核态，则指向产生panic的代码。

#### 3)这样做有哪些好处？

按需加载，节省了时间和空间。

#### 4)处理 10G 连续的内存页面，对应的 SV39 页表大致占用多少内存 (估算数量级即可)？

10G/4K*8=20K。一级页表和二级页表的空间与三级页表相比可忽略不计，因此占用10KB数量级的内存。

#### 5)请简单思考如何才能实现 Lazy 策略，缺页时又如何处理？描述合理即可，不需要考虑实现。

在程序加载时，只为时间上快要执行的代码分配空间。因此，除了访存指令，PC的更新也可能造成缺页中断，需要相应处理机制。

#### 6)此时页面失效如何表现在页表项(PTE)上？

PTE的有效位为0。

### 3. 双页表与单页表

#### 1)在单页表情况下，如何更换页表？

在内核空间中，进行任务切换的时候，执行更换页表的代码，更换页表。

#### 2)单页表情况下，如何控制用户态无法访问内核页面？

使用PTE的U位，标识页面是否能在用户态访问。

#### 3)单页表有何优势？

进行系统调用时不需更换页表。如果程序经常发生中断或者系统调用，则单页表的性能更好。

#### 4)双页表实现下，何时需要更换页表？假设你写一个单页表操作系统，你会选择何时更换页表？

双页表实现下，在中断、系统调用等切换特权级的场合更换页表。

单页表实现下，在进程切换时更换页表。

## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了具体的交流对象及内容：

    群友“涼風青葉”：交流了当`mmap`和`munmap`系统调用的起始地址=结束地址时的特殊情况应该怎么处理。

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

    2023秋冬季训练营第二阶段群的聊天记录：关于使用`get_time_ms`会丢失精度，需要使用`get_time_us`的要点。

3. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

4. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，对应的实验成绩将按“-100”分计。